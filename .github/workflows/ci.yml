name: ğŸ”„ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  validation:
    name: ğŸ§ª Code Validation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ” TypeScript Type Check
        run: npm run type-check

      - name: ğŸ§¹ ESLint Check
        run: npm run lint

      - name: ğŸ’„ Prettier Format Check
        run: npm run format:check

      - name: ğŸ—ï¸ Build Check
        run: npm run build

      - name: ğŸ“Š Upload Build Artifacts
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next/
          retention-days: 1

  security:
    name: ğŸ”’ Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ”§ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: ğŸ“¦ Install Dependencies
        run: npm ci

      - name: ğŸ›¡ï¸ Run Security Audit
        run: npm audit --audit-level=moderate

      - name: ğŸ” Dependency Check
        run: |
          # Check for outdated packages
          npm outdated || true

          # Check for unused dependencies
          npx depcheck --ignores="@types/*,eslint-*,prettier-*,husky,lint-staged" || true

  commit-validation:
    name: ğŸ“ Commit Message Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ“‹ Validate Commit Messages
        run: |
          # Get all commits in the PR
          COMMITS=$(git log --pretty=format:"%s" origin/main..HEAD)

          echo "Validating commit messages:"
          echo "$COMMITS"

          # Validate each commit message
          while IFS= read -r commit; do
            if [[ ! "$commit" =~ ^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+ ]]; then
              echo "âŒ Invalid commit message: '$commit'"
              echo "Commit messages must follow conventional commits format:"
              echo "type(scope): description"
              echo "Examples:"
              echo "  feat: add new button component"
              echo "  fix(header): resolve navigation issue"
              echo "  docs: update README"
              exit 1
            else
              echo "âœ… Valid commit message: '$commit'"
            fi
          done <<< "$COMMITS"

  pr-validation:
    name: ğŸ” Pull Request Validation
    runs-on: ubuntu-latest
    needs: [validation, security, commit-validation]
    if: github.event_name == 'pull_request'

    steps:
      - name: ğŸ“¥ Checkout Repository
        uses: actions/checkout@v4

      - name: ğŸ“Š PR Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const comment = `## ğŸ” PR Validation Summary

            âœ… **All validation checks passed!**

            ### ğŸ“‹ Checks Completed:
            - ğŸ§ª Code validation (TypeScript, ESLint, Prettier)
            - ğŸ—ï¸ Build verification
            - ğŸ”’ Security audit
            - ğŸ“ Commit message validation

            ### ğŸš€ Ready for merge!

            **Branch:** \`${pr.head.ref}\` â†’ \`${pr.base.ref}\`
            **Commits:** ${pr.commits} commits
            **Files changed:** ${pr.changed_files} files

            *This PR will trigger automatic version management when merged to main.*`;

            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c => c.body.includes('PR Validation Summary'));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
