name: üîÑ CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

permissions:
  contents: read
  pull-requests: write

jobs:
  validation:
    name: üß™ Code Validation
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18, 20]

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Setup Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: "npm"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üîç TypeScript Type Check
        run: npm run type-check

      - name: üíÑ Prettier Format Check
        run: npm run format:check

      - name: üèóÔ∏è Build Check
        run: npm run build

      - name: üìä Upload Build Artifacts
        if: matrix.node-version == 20
        uses: actions/upload-artifact@v4
        with:
          name: build-artifacts
          path: .next/
          retention-days: 1

  security:
    name: üîí Security Audit
    runs-on: ubuntu-latest

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üîß Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: üì¶ Install Dependencies
        run: npm ci

      - name: üõ°Ô∏è Run Security Audit
        run: npm audit --audit-level=moderate

      - name: üîç Dependency Check
        run: |
          # Check for outdated packages
          npm outdated || true

          # Check for unused dependencies
          npx depcheck --ignores="@types/*,eslint-*,prettier-*,husky,lint-staged" || true

  commit-validation:
    name: üìù Commit Message Validation
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üìã Validate Commit Messages
        run: |
          # Get all commits in the PR, excluding merge commits
          git log --pretty=format:"%s" --no-merges origin/main..HEAD > commits.txt

          echo "Validating commit messages:"
          cat commits.txt

          # Check if file is empty
          if [ ! -s commits.txt ]; then
            echo "‚ÑπÔ∏è No commits to validate"
            exit 0
          fi

          # Validate each commit message
          while read -r commit; do
            # Skip empty lines
            if [ -z "$commit" ]; then
              continue
            fi
            
            # Use grep for pattern matching instead of bash regex
            if echo "$commit" | grep -qE "^(feat|fix|docs|style|refactor|perf|test|chore|ci|build|revert)(\(.+\))?: .+"; then
              echo "‚úÖ Valid commit message: '$commit'"
            else
              echo "‚ùå Invalid commit message: '$commit'"
              echo "Commit messages must follow conventional commits format:"
              echo "type(scope): description"
              exit 1
            fi
          done < commits.txt

  pr-validation:
    name: üîç Pull Request Validation
    runs-on: ubuntu-latest
    needs: [validation, security, commit-validation]
    if: github.event_name == 'pull_request'

    steps:
      - name: üì• Checkout Repository
        uses: actions/checkout@v4

      - name: üìä PR Summary Comment
        uses: actions/github-script@v7
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });

            const comment = `## üîç PR Validation Summary

            ‚úÖ **All validation checks passed!**

            ### üìã Checks Completed:
            - üß™ Code validation (TypeScript, Prettier)
            - üèóÔ∏è Build verification
            - üîí Security audit
            - üìù Commit message validation

            ### üöÄ Ready for merge!

            **Branch:** \`${pr.head.ref}\` ‚Üí \`${pr.base.ref}\`
            **Commits:** ${pr.commits} commits
            **Files changed:** ${pr.changed_files} files

            *This PR will trigger automatic version management when merged to main.*`;

            // Check if comment already exists
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const existingComment = comments.find(c => c.body.includes('PR Validation Summary'));

            if (existingComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existingComment.id,
                body: comment
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: comment
              });
            }
